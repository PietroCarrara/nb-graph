<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nb Graph</title>
    <style>
        svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>
        function* range(start, end) {
            for (let i = start; i < end; i++) {
                yield i;
            }
        }

        function color2rgb(color) {
            return [
                parseInt(color.substr(1,2),16),
                parseInt(color.substr(3,2),16),
                parseInt(color.substr(5,2),16)
            ];
        }

        function averageRGB(colors) {
            if (colors.length <= 0) {
                return [0, 0, 0];
            }

            var avgR = 0;
            var avgG = 0;
            var avgB = 0;
            for (var color of colors) {
                avgR += color[0];
                avgG += color[1];
                avgB += color[2];
            }

            return [
                Math.round(avgR / colors.length),
                Math.round(avgG / colors.length),
                Math.round(avgB / colors.length),
            ];
        }

        function rgb2color(rgb) {
            return `#${rgb[0].toString(16)}${rgb[1].toString(16)}${rgb[2].toString(16)}`
        }
    </script>
    <script>
        /* __DATA_DECLARATION__ */

        const width = 400;
        const height = 400
        const radius = 5;

        // Generate a sequential id for each node
        for (var i in data) {
            data[i].id = Number(i);
        }

        // Adjacency matrix based on the tags
        // links[i][j] stores how many tags do nodes i and j share
        // j < i must be true when accessing this matrix
        var links = Array(data.length);
        for (var i of range(0, data.length)) {
            links[i] = Array(i).fill(0);
        }
        for (var i in data) {
            for (var j of range(0, i)) {
                for (var tag of data[i].tags) {
                    if (data[j].tags.includes(tag)) {
                        links[i][j]++;
                    }
                }
            }
        }

        // tagColor('#example') = some unique color
        const tagColor = d3.scaleOrdinal(d3.schemePaired);

        // Transform the matrix to a object that d3 understands
        var d3links = [];
        for (var i in links) {
            for (var j of range(0, i)) {
                if (links[i][j] > 0) {
                    d3links.push(Object.create({
                        'source': Number(i),
                        'target': Number(j),
                        'strength': links[i][j],
                    }));
                }
            }
        }
        const d3nodes = data.map(d => Object.create(d));

        const simulation = d3
            .forceSimulation(d3nodes)
            .force('links', d3.forceLink(d3links).id(d => d.id))
            .force('charge', d3.forceManyBody())
            .force("x", d3.forceX())
            .force("y", d3.forceY());

        const svg = d3
            .create('svg')
            .attr('viewBox', [-width/2, -height/2, width, height]);

        const lines = svg
            .append('g')
            .attr('stroke', '#444')
            .selectAll('line')
            .data(d3links)
            .join('line')
            .attr('stroke-width', l => Math.sqrt(l.strength));

        const circles = svg
            .append('g')
            .selectAll('circle')
            .data(d3nodes)
            .join('circle')
            .attr('r', radius)
            .attr('fill', d => rgb2color(averageRGB(d.tags.map(tagColor).map(color2rgb))))
            .attr('stroke', 'black')
            .on('click', function(d) {
                console.log(d3.select(this).data());
            });

        simulation.on('tick', () => {
            lines
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y)

            circles
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
        })

        d3.select('body')
            .append(() => svg.node());
    </script>
</body>

</html>